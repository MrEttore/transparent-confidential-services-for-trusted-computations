upstream evidence_provider_backend {
    ip_hash;

    server 34.7.214.206:8080;
    server 34.158.65.214:8080;
    server 34.12.85.105:8080;

    keepalive 64;
}

log_format paper
    'ts=$time_iso8601 '
    'client_ip=$remote_addr '
    'xff="$http_x_forwarded_for" '
    'method=$request_method '
    'uri="$uri" '
    'status=$status '
    'bytes=$bytes_sent '
    'req_time=$request_time '
    'upstream_addr="$upstream_addr" '
    'upstream_status="$upstream_status" '
    'upstream_time="$upstream_response_time" '
    'req_id="$http_x_request_id"';

server {
    listen 8080;
    server_name _;

    real_ip_header    X-Forwarded-For;
    real_ip_recursive on;
    set_real_ip_from  0.0.0.0/0;

    access_log /dev/stdout paper;
    error_log  /dev/stderr warn;

    location = /health {
        access_log off;
        add_header Content-Type text/plain;
        return 200 "OK\n";
    }

    location / {
        proxy_http_version 1.1;
        proxy_set_header Connection "";

        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-Id      $http_x_request_id;

        proxy_connect_timeout 300s;
        proxy_send_timeout    300s;
        proxy_read_timeout    300s;

        add_header X-Upstream-Addr $upstream_addr always;

        proxy_pass http://evidence_provider_backend;
    }
}
